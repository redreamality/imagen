name: Build and Release Prefab

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶: ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚ v1.0.0)

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ èµ„äº§

jobs:
  validate-build-release:
    runs-on: ubuntu-latest

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: å®‰è£… uv
        uses: astral-sh/setup-uv@v3
        with:
          enable-cache: true

      - name: è®¾ç½® Python ç¯å¢ƒ
        run: uv python install 3.11

      - name: å®‰è£…ä¾èµ–
        run: uv sync --dev

      # ==================== éªŒè¯é˜¶æ®µ ====================

      - name: è¿è¡Œä»£ç é£æ ¼æ£€æŸ¥ (Flake8)
        run: |
          echo "ğŸ” è¿è¡Œ Flake8 ä»£ç é£æ ¼æ£€æŸ¥..."
          uv run --with flake8 flake8 src/ --max-line-length=120 --exclude=__pycache__,*.pyc

      - name: è¿è¡Œå•å…ƒæµ‹è¯• (Pytest)
        run: |
          echo "ğŸ§ª è¿è¡Œå•å…ƒæµ‹è¯•..."
          echo "ğŸ“ æ³¨æ„ï¼šæµ‹è¯•ä½¿ç”¨çœŸå®æ•°æ®æ–‡ä»¶ï¼ˆå¦‚ tests/test.mp4ï¼‰ç¡®ä¿åŠŸèƒ½å¯ç”¨æ€§"
          uv run --with pytest pytest tests/ -v --tb=short

      - name: æµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
        run: |
          echo "ğŸ“Š ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š..."
          uv run --with pytest --with pytest-cov pytest tests/ --cov=src --cov-report=term-missing

      - name: éªŒè¯ Manifest ä¸ä»£ç ä¸€è‡´æ€§
        run: |
          echo "ğŸ” éªŒè¯ prefab-manifest.json ä¸ src/main.py çš„ä¸€è‡´æ€§..."
          uv run python scripts/validate_manifest.py

      - name: éªŒè¯ç‰ˆæœ¬å·ä¸€è‡´æ€§
        run: |
          echo "ğŸ” éªŒè¯ Git Tagã€pyproject.toml ä¸ prefab-manifest.json ç‰ˆæœ¬å·ä¸€è‡´æ€§..."
          TAG_VERSION="${GITHUB_REF#refs/tags/v}"
          MANIFEST_VERSION=$(python -c "import json; print(json.load(open('prefab-manifest.json'))['version'])")
          PYPROJECT_VERSION=$(python -c "import tomllib; print(tomllib.load(open('pyproject.toml', 'rb'))['project']['version'])")

          echo "Git Tag ç‰ˆæœ¬: $TAG_VERSION"
          echo "Manifest ç‰ˆæœ¬: $MANIFEST_VERSION"
          echo "Pyproject ç‰ˆæœ¬: $PYPROJECT_VERSION"

          if [ "$TAG_VERSION" != "$MANIFEST_VERSION" ]; then
            echo "âŒ é”™è¯¯: Git Tag ç‰ˆæœ¬ ($TAG_VERSION) ä¸ manifest ç‰ˆæœ¬ ($MANIFEST_VERSION) ä¸ä¸€è‡´"
            exit 1
          fi

          if [ "$TAG_VERSION" != "$PYPROJECT_VERSION" ]; then
            echo "âŒ é”™è¯¯: Git Tag ç‰ˆæœ¬ ($TAG_VERSION) ä¸ pyproject.toml ç‰ˆæœ¬ ($PYPROJECT_VERSION) ä¸ä¸€è‡´"
            exit 1
          fi

          echo "âœ… ç‰ˆæœ¬å·éªŒè¯é€šè¿‡: $TAG_VERSION"

      # ==================== æ„å»ºé˜¶æ®µ ====================

      - name: æ„å»º Wheel åŒ…
        run: |
          echo "ğŸ“¦ æ„å»º Python Wheel åŒ…..."
          uv build --wheel
          echo "âœ… Wheel åŒ…æ„å»ºå®Œæˆ"

      - name: æå–åŒ…ä¿¡æ¯
        id: package
        run: |
          echo "ğŸ“‹ æå–åŒ…ä¿¡æ¯..."
          MANIFEST_ID=$(python -c "import json; print(json.load(open('prefab-manifest.json'))['id'])")
          MANIFEST_VERSION=$(python -c "import json; print(json.load(open('prefab-manifest.json'))['version'])")

          # æŸ¥æ‰¾ç”Ÿæˆçš„ wheel æ–‡ä»¶
          WHEEL_FILE=$(ls dist/*.whl | head -n 1)
          PACKAGE_NAME=$(basename "$WHEEL_FILE")

          echo "âœ… åŒ…ä¿¡æ¯æå–å®Œæˆ"
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "package_path=${WHEEL_FILE}" >> $GITHUB_OUTPUT
          echo "manifest_id=${MANIFEST_ID}" >> $GITHUB_OUTPUT
          echo "manifest_version=${MANIFEST_VERSION}" >> $GITHUB_OUTPUT

      - name: éªŒè¯ Wheel åŒ…
        run: |
          WHEEL_FILE="${{ steps.package.outputs.package_path }}"
          echo "ğŸ” éªŒè¯ Wheel åŒ…: ${WHEEL_FILE}"

          if [ ! -f "${WHEEL_FILE}" ]; then
            echo "âŒ é”™è¯¯: Wheel åŒ…ä¸å­˜åœ¨"
            exit 1
          fi

          FILE_SIZE=$(stat -f%z "${WHEEL_FILE}" 2>/dev/null || stat -c%s "${WHEEL_FILE}")
          echo "ğŸ“Š æ–‡ä»¶å¤§å°: ${FILE_SIZE} bytes"

          echo "ğŸ“‹ Wheel åŒ…å†…å®¹:"
          unzip -l "${WHEEL_FILE}" | head -30

          # éªŒè¯ prefab-manifest.json æ˜¯å¦åœ¨åŒ…å†…
          if unzip -l "${WHEEL_FILE}" | grep -q "prefab-manifest.json"; then
            echo "âœ… prefab-manifest.json å·²åŒ…å«åœ¨ Wheel åŒ…ä¸­"
          else
            echo "âŒ é”™è¯¯: prefab-manifest.json æœªåŒ…å«åœ¨ Wheel åŒ…ä¸­"
            exit 1
          fi

          echo "âœ… Wheel åŒ…éªŒè¯é€šè¿‡"

      # ==================== å‘å¸ƒé˜¶æ®µ ====================

      - name: åˆ›å»º GitHub Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: |
            ## ğŸ‰ é¢„åˆ¶ä»¶å‘å¸ƒ: ${{ steps.package.outputs.manifest_id }}

            **ç‰ˆæœ¬:** ${{ steps.package.outputs.manifest_version }}
            **æ ‡ç­¾:** ${{ github.ref_name }}

            ### ğŸ“¦ ä¸‹è½½
            ä¸‹è½½ä¸‹æ–¹çš„ `.whl` æ–‡ä»¶å³å¯ä½¿ç”¨æ­¤é¢„åˆ¶ä»¶ã€‚

            ### ğŸš€ ä½¿ç”¨æ–¹æ³•
            è¯·å‚è€ƒ [README.md](https://github.com/${{ github.repository }}/blob/${{ github.ref_name }}/README.md) äº†è§£è¯¦ç»†ä½¿ç”¨è¯´æ˜ã€‚

            ### ğŸ“‹ å˜æ›´è¯´æ˜
            - é‡‡ç”¨ Python Wheel æ ¼å¼æ‰“åŒ…
            - æ‰€æœ‰ä¾èµ–å·²åŒ…å«åœ¨åŒ…å†…
            - åŒ…å«å®Œæ•´çš„ prefab-manifest.json å…ƒæ•°æ®

            ---
            _æ­¤ Release ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆ_
          draft: false
          prerelease: false

      - name: ä¸Šä¼ é¢„åˆ¶ä»¶åŒ…
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ${{ steps.package.outputs.package_path }}
          asset_name: ${{ steps.package.outputs.package_name }}
          asset_content_type: application/zip

      - name: å‘å¸ƒæˆåŠŸ
        run: |
          echo "ğŸ‰ é¢„åˆ¶ä»¶å‘å¸ƒæˆåŠŸ!"
          echo "ğŸ“¦ åŒ…å: ${{ steps.package.outputs.package_name }}"
          echo "ğŸ”— Release URL: ${{ steps.create_release.outputs.html_url }}"
